<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Ti√™n Multiplayer Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="client-socket-manager.js"></script>
    <link rel="stylesheet" href="css/auth.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Main Layout */
        .game-layout {
            display: grid;
            grid-template-areas: 
                "header header header"
                "sidebar main chat"
                "footer footer footer";
            grid-template-columns: 250px 1fr 300px;
            grid-template-rows: 80px 1fr 60px;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        /* Header */
        .game-header {
            grid-area: header;
            background: linear-gradient(135deg, #4a148c 0%, #7b1fa2 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 5px 20px rgba(74, 20, 140, 0.3);
        }

        .game-title {
            font-size: 2.2em;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .connected .status-indicator {
            background: #4caf50;
        }

        .disconnected .status-indicator {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Sidebar */
        .game-sidebar {
            grid-area: sidebar;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ff6b35;
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin: 0 auto 15px;
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }

        .stat-bar {
            margin-bottom: 10px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .stat-progress {
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .health-fill { background: linear-gradient(90deg, #f44336, #ff9800); }
        .mana-fill { background: linear-gradient(90deg, #2196f3, #00bcd4); }
        .exp-fill { background: linear-gradient(90deg, #4caf50, #8bc34a); }

        /* Main Content */
        .game-main {
            grid-area: main;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        .main-tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 5px;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #ccc;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #4a148c 0%, #7b1fa2 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(74, 20, 140, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Chat Panel */
        .game-chat {
            grid-area: chat;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            max-height: 400px;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 5px 0;
            font-size: 0.9em;
        }

        .chat-sender {
            font-weight: bold;
            color: #ff6b35;
        }

        .chat-timestamp {
            color: #888;
            font-size: 0.8em;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            outline: none;
        }

        .chat-input input::placeholder {
            color: #888;
        }

        .chat-send-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4a148c 0%, #7b1fa2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 20, 140, 0.4);
        }

        /* Footer */
        .game-footer {
            grid-area: footer;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .footer-info {
            display: flex;
            gap: 30px;
            font-size: 0.9em;
            color: #ccc;
        }

        .footer-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #4a148c 0%, #7b1fa2 100%);
            color: white;
            margin: 5px;
            font-size: 0.9em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 20, 140, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success { background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); }
        .btn-warning { background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%); }
        .btn-danger { background: linear-gradient(135deg, #f44336 0%, #e91e63 100%); }
        .btn-info { background: linear-gradient(135deg, #2196f3 0%, #00bcd4 100%); }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        /* Additional UI Elements */
        .inventory-slot {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .inventory-slot:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b35;
            transform: translateY(-2px);
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .quest-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .quest-title {
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 5px;
        }

        .quest-progress {
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 10px;
        }

        /* Game time and stats */
        .game-time {
            font-family: 'Consolas', 'Courier New', monospace;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .game-layout {
                grid-template-areas: 
                    "header header"
                    "main chat"
                    "sidebar sidebar"
                    "footer footer";
                grid-template-columns: 1fr 300px;
                grid-template-rows: 80px 1fr 200px 60px;
            }
        }

        @media (max-width: 768px) {
            .game-layout {
                grid-template-areas: 
                    "header"
                    "main"
                    "chat"
                    "sidebar"
                    "footer";
                grid-template-columns: 1fr;
                grid-template-rows: 80px 1fr 200px 200px 60px;
            }
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4a148c 0%, #7b1fa2 100%);
            border-radius: 10px;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        .connected {
            background: #4caf50;
            color: white;
        }

        .disconnected {
            background: #f44336;
            color: white;
        }

        .game-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel h3 {
            margin-top: 0;
            color: #ff6b35;
            border-bottom: 2px solid #ff6b35;
            padding-bottom: 10px;
        }

        .player-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff6b35;
        }

        .stat-label {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 5px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #4a148c 0%, #7b1fa2 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 20, 140, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }

        .log-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }

        .log-success {
            color: #4caf50;
        }

        .log-error {
            color: #f44336;
        }

        .log-info {
            color: #2196f3;
        }

        .chat-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .chat-sender {
            font-weight: bold;
            color: #ff6b35;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .chat-input button {
            padding: 10px 20px;
            background: #4a148c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .players-list {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .player-name {
            font-weight: bold;
        }

        .player-level {
            color: #ff6b35;
        }

        .player-power {
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="game-layout">
            <!-- Header -->
            <header class="game-header">
                <div class="game-title">üêâ Tu Ti√™n Multiplayer Game</div>
                <div class="header-controls">
                    <div id="authStatus" class="auth-status">
                        <span id="playerName">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
                        <button id="loginBtn" class="auth-btn" onclick="showAuthModal()">ƒêƒÉng Nh·∫≠p</button>
                        <button id="logoutBtn" class="auth-btn logout" onclick="logout()" style="display: none;">ƒêƒÉng Xu·∫•t</button>
                    </div>
                    <div id="connectionStatus" class="connection-status disconnected">
                        <div class="status-indicator"></div>
                        <span>Disconnected</span>
                    </div>
                </div>
            </header>

        <!-- Sidebar -->
        <aside class="game-sidebar">
            <div class="sidebar-section">
                <div class="player-avatar">üë§</div>
                <div class="sidebar-title">Th√¥ng Tin Nh√¢n V·∫≠t</div>
                
                <div class="stat-bar">
                    <div class="stat-label">
                        <span>üíñ Sinh L·ª±c</span>
                        <span id="healthText">100/100</span>
                    </div>
                    <div class="stat-progress">
                        <div class="stat-fill health-fill" id="healthBar" style="width: 100%"></div>
                    </div>
                </div>

                <div class="stat-bar">
                    <div class="stat-label">
                        <span>üíô Ph√°p L·ª±c</span>
                        <span id="manaText">50/50</span>
                    </div>
                    <div class="stat-progress">
                        <div class="stat-fill mana-fill" id="manaBar" style="width: 100%"></div>
                    </div>
                </div>

                <div class="stat-bar">
                    <div class="stat-label">
                        <span>‚≠ê Kinh Nghi·ªám</span>
                        <span id="expText">0/100</span>
                    </div>
                    <div class="stat-progress">
                        <div class="stat-fill exp-fill" id="expBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">T√†i Nguy√™n</div>
                <div style="font-size: 0.9em; line-height: 1.8;">
                    <div>üí∞ V√†ng: <span id="goldAmount">100</span></div>
                    <div>üíé KNB: <span id="knbAmount">0</span></div>
                    <div>üîÆ Linh Th·∫°ch: <span id="spiritStones">0</span></div>
                    <div>‚ö° S·ª©c M·∫°nh: <span id="powerAmount">0</span></div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Tu Luy·ªán</div>
                <div style="font-size: 0.9em; line-height: 1.8;">
                    <div>C·∫£nh Gi·ªõi: <span id="cultivationRealm">Ph√†m Nh√¢n</span></div>
                    <div>C·∫•p: <span id="cultivationStage">1</span></div>
                    <div>Ti·∫øn ƒê·ªô: <span id="cultivationProgress">0%</span></div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">ƒê·ªìng H√†nh</div>
                <div style="font-size: 0.9em; line-height: 1.8;">
                    <div>ü¶ä Linh Th√∫: <span id="petName">Ch∆∞a c√≥</span></div>
                    <div>üë∞ ƒê·∫°o L·ªØ: <span id="wifeName">Ch∆∞a c√≥</span></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="game-main">
            <div class="main-tabs">
                <button class="tab-button active" onclick="switchTab('character')">üë§ Nh√¢n V·∫≠t</button>
                <button class="tab-button" onclick="switchTab('inventory')">üéí T√∫i ƒê·ªì</button>
                <button class="tab-button" onclick="switchTab('companion')">üêæ ƒê·ªìng H√†nh</button>
                <button class="tab-button" onclick="switchTab('quest')">üìú Nhi·ªám V·ª•</button>
                <button class="tab-button" onclick="switchTab('guild')">üè∞ Bang H·ªôi</button>
                <button class="tab-button" onclick="switchTab('shop')">üõí C·ª≠a H√†ng</button>
                <button class="tab-button" onclick="switchTab('arena')">‚öîÔ∏è ƒê·∫•u Tr∆∞·ªùng</button>
            </div>

            <!-- Character Tab -->
            <div id="characterTab" class="tab-content active">
                <div class="card">
                    <div class="card-title">üßò Tu Luy·ªán</div>
                    <div class="grid-2">
                        <div>
                            <button class="btn btn-warning" onclick="cultivate(1000)">
                                üßò Tu Luy·ªán 1s
                            </button>
                            <button class="btn btn-warning" onclick="cultivate(5000)">
                                üßò Tu Luy·ªán 5s
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="useItem('cultivation_pill')">
                                üíä D√πng Tu Luy·ªán ƒêan
                            </button>
                            <button class="btn btn-info" onclick="useItem('experience_pill')">
                                üíä D√πng Kinh Nghi·ªám ƒêan
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">‚öîÔ∏è Chi·∫øn ƒê·∫•u</div>
                    <div class="grid-3">
                        <button class="btn btn-success" onclick="useItem('hp_potion_small')">
                            üç∑ B√¨nh M√°u
                        </button>
                        <button class="btn btn-info" onclick="useItem('mana_potion_small')">
                            üíô B√¨nh Mana
                        </button>
                        <button class="btn btn-warning" onclick="useItem('gold_pouch')">
                            üí∞ T√∫i V√†ng
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üéØ H√†nh ƒê·ªông Nhanh</div>
                    <div class="grid-4">
                        <button class="btn" onclick="obtainPet('fire_fox')">
                            ü¶ä Linh Th√∫
                        </button>
                        <button class="btn" onclick="obtainWife('ice_fairy')">
                            üë∞ ƒê·∫°o L·ªØ
                        </button>
                        <button class="btn" onclick="acceptQuest('first_cultivation')">
                            üìú Nhi·ªám V·ª•
                        </button>
                        <button class="btn btn-danger" onclick="adminAddKNB(1000)">
                            üíé +1000 KNB
                        </button>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventoryTab" class="tab-content">
                <div class="card">
                    <div class="card-title">üéí T√∫i ƒê·ªì</div>
                    <div id="inventoryItems" class="grid-4">
                        <div class="inventory-slot">Tr·ªëng</div>
                    </div>
                </div>
            </div>

            <!-- Companion Tab -->
            <div id="companionTab" class="tab-content">
                <div class="card">
                    <div class="card-title">ü¶ä Linh Th√∫</div>
                    <div id="petInfo">
                        <p>Ch∆∞a c√≥ linh th√∫</p>
                        <button class="btn" onclick="obtainPet('fire_fox')">Thu th·∫≠p H·ªì Ly L·ª≠a</button>
                        <button class="btn" onclick="obtainPet('ice_wolf')">Thu th·∫≠p S√≥i BƒÉng</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üë∞ ƒê·∫°o L·ªØ</div>
                    <div id="wifeInfo">
                        <p>Ch∆∞a c√≥ ƒë·∫°o l·ªØ</p>
                        <button class="btn" onclick="obtainWife('ice_fairy')">K·∫øt duy√™n BƒÉng Ti√™n T·ª≠</button>
                    </div>
                </div>
            </div>

            <!-- Quest Tab -->
            <div id="questTab" class="tab-content">
                <div class="card">
                    <div class="card-title">üìú Nhi·ªám V·ª• Ho·∫°t ƒê·ªông</div>
                    <div id="activeQuests">
                        <p>Ch∆∞a c√≥ nhi·ªám v·ª•</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üéØ Nhi·ªám V·ª• C√≥ Th·ªÉ Nh·∫≠n</div>
                    <div>
                        <button class="btn" onclick="acceptQuest('first_cultivation')">Tu Luy·ªán ƒê·∫ßu Ti√™n</button>
                        <button class="btn" onclick="acceptQuest('level_up_quest')">L√™n C·∫•p</button>
                    </div>
                </div>
            </div>

            <!-- Guild Tab -->
            <div id="guildTab" class="tab-content">
                <div class="card">
                    <div class="card-title">üè∞ Bang H·ªôi</div>
                    <div id="guildInfo">
                        <p>Ch∆∞a tham gia bang h·ªôi</p>
                        <button class="btn" onclick="joinGuild('test_guild')">Tham gia bang h·ªôi</button>
                    </div>
                </div>
            </div>

            <!-- Shop Tab -->
            <div id="shopTab" class="tab-content">
                <div class="card">
                    <div class="card-title">üõí C·ª≠a H√†ng Th∆∞·ªùng</div>
                    <div class="grid-3">
                        <div class="shop-item">
                            <div>üç∑ B√¨nh M√°u Nh·ªè</div>
                            <div>üí∞ 10 V√†ng</div>
                            <button class="btn btn-success" onclick="buyItem('hp_potion_small', 10)">Mua</button>
                        </div>
                        <div class="shop-item">
                            <div>üíô B√¨nh Mana Nh·ªè</div>
                            <div>üí∞ 8 V√†ng</div>
                            <button class="btn btn-info" onclick="buyItem('mana_potion_small', 8)">Mua</button>
                        </div>
                        <div class="shop-item">
                            <div>üíä Tu Luy·ªán ƒêan</div>
                            <div>üí∞ 150 V√†ng</div>
                            <button class="btn btn-warning" onclick="buyItem('cultivation_pill', 150)">Mua</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üíé K·ª≥ Tr√¢n C√°c (KNB)</div>
                    <div class="grid-2">
                        <div class="shop-item">
                            <div>üìÖ Th·∫ª Th√°ng</div>
                            <div>üíé 500 KNB</div>
                            <button class="btn btn-danger" onclick="purchasePremiumItem('monthly_card')">Mua</button>
                        </div>
                        <div class="shop-item">
                            <div>üêé Th√∫ C∆∞·ª°i Hi·∫øm</div>
                            <div>üíé 2500 KNB</div>
                            <button class="btn btn-danger" onclick="purchasePremiumItem('rare_mount')">Mua</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Arena Tab -->
            <div id="arenaTab" class="tab-content">
                <div class="card">
                    <div class="card-title">‚öîÔ∏è ƒê·∫•u Tr∆∞·ªùng</div>
                    <div>
                        <p>X·∫øp h·∫°ng: <span id="arenaRank">Ch∆∞a x·∫øp h·∫°ng</span></p>
                        <p>ƒêi·ªÉm: <span id="arenaPoints">1000</span></p>
                        <p>Th·∫Øng: <span id="arenaWins">0</span> | Thua: <span id="arenaLosses">0</span></p>
                        <button class="btn btn-warning" onclick="startArenaMatch()">B·∫Øt ƒë·∫ßu tr·∫≠n ƒë·∫•u</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Chat Panel -->
        <aside class="game-chat">
            <div class="sidebar-title">üí¨ Chat</div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message">
                    <span class="chat-timestamp">[00:00:00]</span>
                    <span class="log-info">Ch√†o m·ª´ng ƒë·∫øn v·ªõi Tu Ti√™n Multiplayer!</span>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleChatKeyPress(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()">G·ª≠i</button>
            </div>
        </aside>

        <!-- Footer -->
        <footer class="game-footer">
            <div class="footer-info">
                <div class="footer-stat">
                    <span>üë• Online:</span>
                    <span id="onlineCount">1</span>
                </div>
                <div class="footer-stat">
                    <span>üè† Ph√≤ng:</span>
                    <span id="roomName">Khu V·ª±c Ch√≠nh</span>
                </div>
                <div class="footer-stat">
                    <span>‚è∞ Th·ªùi gian:</span>
                    <span id="gameTime">00:00:00</span>
                </div>
            </div>
            <div class="footer-info">
                <div class="footer-stat">
                    <span>üéÆ FPS:</span>
                    <span id="fps">60</span>
                </div>
                <div class="footer-stat">
                    <span>üìä Ping:</span>
                    <span id="ping">0ms</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <button class="close-modal" onclick="hideAuthModal()">&times;</button>
            
            <div class="auth-modal-header">
                <h2>üêâ Tu Ti√™n Game</h2>
                <p>ƒêƒÉng nh·∫≠p ho·∫∑c ƒëƒÉng k√Ω ƒë·ªÉ l∆∞u ti·∫øn ƒë·ªô</p>
            </div>

            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">ƒêƒÉng Nh·∫≠p</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">ƒêƒÉng K√Ω</div>
            </div>

            <!-- Login Form -->
            <form id="modalLoginForm" class="auth-form active">
                <div class="form-group">
                    <label for="modalLoginUsername">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="modalLoginUsername" name="username" required>
                    <div class="error-message" id="modalLoginUsernameError"></div>
                </div>

                <div class="form-group">
                    <label for="modalLoginPassword">M·∫≠t kh·∫©u</label>
                    <input type="password" id="modalLoginPassword" name="password" required>
                    <div class="error-message" id="modalLoginPasswordError"></div>
                </div>

                <button type="submit" class="auth-button" id="modalLoginButton">
                    ƒêƒÉng Nh·∫≠p
                </button>

                <div class="auth-links">
                    <a href="#" onclick="switchAuthTab('forgot-password')">Qu√™n m·∫≠t kh·∫©u?</a>
                </div>
            </form>

            <!-- Register Form -->
            <form id="modalRegisterForm" class="auth-form">
                <div class="form-group">
                    <label for="modalRegisterUsername">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="modalRegisterUsername" name="username" required>
                    <div class="error-message" id="modalRegisterUsernameError"></div>
                </div>

                <div class="form-group">
                    <label for="modalRegisterEmail">Email (t√πy ch·ªçn)</label>
                    <input type="email" id="modalRegisterEmail" name="email">
                    <div class="error-message" id="modalRegisterEmailError"></div>
                </div>

                <div class="form-group">
                    <label for="modalRegisterName">T√™n hi·ªÉn th·ªã</label>
                    <input type="text" id="modalRegisterName" name="name">
                    <div class="error-message" id="modalRegisterNameError"></div>
                </div>

                <div class="form-group">
                    <label for="modalRegisterPassword">M·∫≠t kh·∫©u</label>
                    <input type="password" id="modalRegisterPassword" name="password" required>
                    <div class="password-requirements" id="modalPasswordRequirements">
                        <ul>
                            <li id="modalReqLength">√çt nh·∫•t 6 k√Ω t·ª±</li>
                            <li id="modalReqLowercase">C√≥ ch·ªØ th∆∞·ªùng</li>
                            <li id="modalReqUppercase">C√≥ ch·ªØ hoa</li>
                            <li id="modalReqNumber">C√≥ s·ªë</li>
                        </ul>
                    </div>
                    <div class="error-message" id="modalRegisterPasswordError"></div>
                </div>

                <div class="form-group">
                    <label for="modalConfirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                    <input type="password" id="modalConfirmPassword" name="confirmPassword" required>
                    <div class="error-message" id="modalConfirmPasswordError"></div>
                </div>

                <button type="submit" class="auth-button" id="modalRegisterButton">
                    ƒêƒÉng K√Ω
                </button>
            </form>

            <!-- Forgot Password Form -->
            <form id="modalForgotPasswordForm" class="auth-form">
                <div class="form-group">
                    <label for="modalForgotEmail">Email</label>
                    <input type="email" id="modalForgotEmail" name="email" required>
                    <div class="error-message" id="modalForgotEmailError"></div>
                </div>

                <button type="submit" class="auth-button" id="modalForgotButton">
                    G·ª≠i Email ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u
                </button>

                <div class="auth-links">
                    <a href="#" onclick="switchAuthTab('login')">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                </div>
            </form>

            <div class="loading" id="modalLoading">
                <div class="loading-spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            player: {
                id: null,
                name: 'Ng∆∞·ªùi Ch∆°i',
                username: null,
                level: 1,
                health: 100,
                maxHealth: 100,
                mana: 50,
                maxMana: 50,
                experience: 0,
                experienceToNext: 100,
                gold: 100,
                power: 0,
                cultivation: { 
                    realm: 'Ph√†m Nh√¢n', 
                    stage: 1, 
                    progress: 0,
                    progressToNext: 1000
                },
                stats: { attack: 10, defense: 5, speed: 8, intelligence: 5, luck: 5 },
                pet: { petId: null, name: null },
                wife: { wifeId: null, name: null },
                inventory: { items: [] },
                resources: { 
                    gold: 100, 
                    spirit_stones: 0, 
                    cultivation_pills: 0, 
                    kim_nguyen_bao: 0 
                },
                arenaStats: {
                    rank: 'Ch∆∞a x·∫øp h·∫°ng',
                    points: 1000,
                    wins: 0,
                    losses: 0
                },
                activeQuests: [],
                guild: null,
                isVerified: false
            },
            players: [],
            connected: false,
            currentTab: 'character',
            authenticated: false,
            authToken: null
        };

        // Socket manager
        let socketManager = new ClientSocketManager();

        // Check authentication on page load
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            const playerData = localStorage.getItem('playerData');
            
            if (token && playerData) {
                try {
                    gameState.authToken = token;
                    gameState.authenticated = true;
                    gameState.player = { ...gameState.player, ...JSON.parse(playerData) };
                    console.log('‚úÖ User authenticated:', gameState.player.username);
                } catch (error) {
                    console.error('‚ùå Invalid stored data:', error);
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('playerData');
                }
            }
        }

        // Authentication functions
        async function login(username, password) {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();
                
                if (result.success) {
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('playerData', JSON.stringify(result.player));
                    gameState.authToken = result.token;
                    gameState.authenticated = true;
                    gameState.player = { ...gameState.player, ...result.player };
                    addLog('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
                    return true;
                } else {
                    addLog(result.message, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Login error:', error);
                addLog('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message, 'error');
                return false;
            }
        }

        async function register(username, email, name, password) {
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, email, name, password })
                });

                const result = await response.json();
                
                if (result.success) {
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('playerData', JSON.stringify(result.player));
                    gameState.authToken = result.token;
                    gameState.authenticated = true;
                    gameState.player = { ...gameState.player, ...result.player };
                    addLog('ƒêƒÉng k√Ω th√†nh c√¥ng!', 'success');
                    return true;
                } else {
                    addLog(result.message, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Register error:', error);
                addLog('L·ªói ƒëƒÉng k√Ω: ' + error.message, 'error');
                return false;
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('playerData');
            gameState.authToken = null;
            gameState.authenticated = false;
            gameState.player.username = null;
            gameState.player.isVerified = false;
            updateAuthUI();
            addLog('ƒê√£ ƒëƒÉng xu·∫•t', 'info');
        }

        // Authentication Modal Functions
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            clearModalErrors();
        }

        function switchAuthTab(tabName) {
            // Update tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="switchAuthTab('${tabName}')"]`).classList.add('active');

            // Update forms
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById('modal' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Form').classList.add('active');

            clearModalErrors();
        }

        function clearModalErrors() {
            document.querySelectorAll('.error-message, .success-message').forEach(msg => {
                msg.style.display = 'none';
                msg.textContent = '';
            });
            document.querySelectorAll('input').forEach(input => {
                input.classList.remove('error', 'success');
            });
        }

        function showModalError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);
            
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            inputElement.classList.add('error');
        }

        function showModalSuccess(fieldId, message) {
            const successElement = document.getElementById(fieldId + 'Success') || document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);
            
            successElement.textContent = message;
            successElement.style.display = 'block';
            successElement.style.color = '#27ae60';
            inputElement.classList.add('success');
        }

        function showModalLoading() {
            document.getElementById('modalLoading').style.display = 'block';
            document.querySelectorAll('.auth-button').forEach(btn => {
                btn.disabled = true;
            });
        }

        function hideModalLoading() {
            document.getElementById('modalLoading').style.display = 'none';
            document.querySelectorAll('.auth-button').forEach(btn => {
                btn.disabled = false;
            });
        }

        function updateAuthUI() {
            const playerNameElement = document.getElementById('playerName');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (gameState.authenticated && gameState.player.username) {
                playerNameElement.textContent = gameState.player.username;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
            } else {
                playerNameElement.textContent = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
            }
        }

        // Modal form handlers
        document.getElementById('modalLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearModalErrors();
            showModalLoading();

            const username = document.getElementById('modalLoginUsername').value;
            const password = document.getElementById('modalLoginPassword').value;

            const success = await login(username, password);
            if (success) {
                hideAuthModal();
                updateAuthUI();
            }
            hideModalLoading();
        });

        document.getElementById('modalRegisterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearModalErrors();
            showModalLoading();

            const username = document.getElementById('modalRegisterUsername').value;
            const email = document.getElementById('modalRegisterEmail').value;
            const name = document.getElementById('modalRegisterName').value;
            const password = document.getElementById('modalRegisterPassword').value;
            const confirmPassword = document.getElementById('modalConfirmPassword').value;

            // Validate password
            if (!validatePassword(password)) {
                showModalError('modalRegisterPassword', 'M·∫≠t kh·∫©u kh√¥ng ƒë√°p ·ª©ng y√™u c·∫ßu');
                hideModalLoading();
                return;
            }

            // Validate password confirmation
            if (!validatePasswordConfirmation(password, confirmPassword)) {
                showModalError('modalConfirmPassword', 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
                hideModalLoading();
                return;
            }

            const success = await register(username, email, name, password);
            if (success) {
                hideAuthModal();
                updateAuthUI();
            }
            hideModalLoading();
        });

        document.getElementById('modalForgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearModalErrors();
            showModalLoading();

            const email = document.getElementById('modalForgotEmail').value;

            try {
                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });

                const result = await response.json();
                
                if (result.success) {
                    showModalSuccess('modalForgotEmail', result.message);
                } else {
                    showModalError('modalForgotEmail', result.message);
                }
            } catch (error) {
                showModalError('modalForgotEmail', 'L·ªói: ' + error.message);
            }
            hideModalLoading();
        });

        // Password validation functions
        function validatePassword(password) {
            const requirements = {
                length: password.length >= 6,
                lowercase: /[a-z]/.test(password),
                uppercase: /[A-Z]/.test(password),
                number: /\d/.test(password)
            };

            // Update UI
            Object.keys(requirements).forEach(req => {
                const element = document.getElementById(`modalReq${req.charAt(0).toUpperCase() + req.slice(1)}`);
                if (element) {
                    element.classList.toggle('valid', requirements[req]);
                    element.classList.toggle('invalid', !requirements[req]);
                }
            });

            return Object.values(requirements).every(req => req);
        }

        function validatePasswordConfirmation(password, confirmPassword) {
            return password === confirmPassword;
        }

        // Real-time password validation
        document.getElementById('modalRegisterPassword').addEventListener('input', (e) => {
            validatePassword(e.target.value);
        });

        document.getElementById('modalConfirmPassword').addEventListener('input', (e) => {
            const password = document.getElementById('modalRegisterPassword').value;
            const confirmPassword = e.target.value;

            if (confirmPassword && !validatePasswordConfirmation(password, confirmPassword)) {
                showModalError('modalConfirmPassword', 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
            } else {
                clearModalErrors();
            }
        });

        // Initialize game
        function initGame() {
            checkAuthentication();
            updateAuthUI();
            setupSocketEvents();
            socketManager.connect();
            addLog('Kh·ªüi t·∫°o game...', 'info');
        }

        function setupSocketEvents() {
            // Connection events
            socketManager.on('connected', () => {
                gameState.connected = true;
                updateConnectionStatus();
                addLog('ƒê√£ k·∫øt n·ªëi ƒë·∫øn server!', 'success');
                
                // Join game with player data
                socketManager.joinGame({
                    name: gameState.player.name,
                    level: gameState.player.level,
                    health: gameState.player.health,
                    maxHealth: gameState.player.maxHealth,
                    mana: gameState.player.mana,
                    maxMana: gameState.player.maxMana,
                    cultivation: gameState.player.cultivation,
                    stats: gameState.player.stats,
                    pet: gameState.player.pet,
                    wife: gameState.player.wife,
                    inventory: gameState.player.inventory,
                    resources: gameState.player.resources
                });
            });

            socketManager.on('disconnected', (reason) => {
                gameState.connected = false;
                updateConnectionStatus();
                addLog(`M·∫•t k·∫øt n·ªëi: ${reason}`, 'error');
            });

            socketManager.on('connection_error', () => {
                addLog('L·ªói k·∫øt n·ªëi ƒë·∫øn server!', 'error');
            });

            // Game events
            socketManager.on('player_data', (data) => {
                gameState.player = { ...gameState.player, ...data };
                updatePlayerInfo();
                addLog(`ƒê√£ nh·∫≠n d·ªØ li·ªáu ng∆∞·ªùi ch∆°i: ${data.name}`, 'success');
            });

            socketManager.on('command_result', (result) => {
                addLog(`K·∫øt qu·∫£: ${result.message}`, 'success');
                
                // Update player data if provided
                if (result.healthUpdate) {
                    gameState.player.health = result.healthUpdate.current;
                    gameState.player.maxHealth = result.healthUpdate.max;
                }
                if (result.manaUpdate) {
                    gameState.player.mana = result.manaUpdate.current;
                    gameState.player.maxMana = result.manaUpdate.max;
                }
                if (result.resourceUpdate) {
                    gameState.player.resources.gold = result.resourceUpdate.gold;
                }
                if (result.expUpdate) {
                    gameState.player.experience = result.expUpdate.current;
                }
                if (result.cultivationUpdate) {
                    gameState.player.cultivation.progress = result.cultivationUpdate.progress;
                }
                if (result.levelUp) {
                    gameState.player.level = result.levelUp.newLevel;
                    addLog(`üéâ L√™n c·∫•p ${result.levelUp.newLevel}!`, 'success');
                }
                if (result.breakthrough) {
                    gameState.player.cultivation.stage = result.breakthrough.newStage;
                    addLog(`‚ú® ƒê·ªôt ph√° c·∫£nh gi·ªõi! C·∫•p ${result.breakthrough.newStage}`, 'success');
                }
                if (result.pet) {
                    gameState.player.pet = result.pet;
                    addLog(`ü¶ä ƒê√£ thu th·∫≠p linh th√∫: ${result.pet.name || 'Unknown'}`, 'success');
                }
                if (result.wife) {
                    gameState.player.wife = result.wife;
                    addLog(`üë∞ ƒê√£ k·∫øt duy√™n: ${result.wife.name || 'Unknown'}`, 'success');
                }
                
                updatePlayerInfo();
            });

            socketManager.on('command_error', (error) => {
                addLog(`L·ªói: ${error.message}`, 'error');
            });

            socketManager.on('room_players', (players) => {
                gameState.players = players;
                updatePlayersList();
            });

            socketManager.on('player_joined', (data) => {
                addLog(`${data.name} ƒë√£ tham gia!`, 'info');
            });

            socketManager.on('player_left', (data) => {
                addLog(`${data.name} ƒë√£ r·ªùi kh·ªèi game`, 'info');
            });

            socketManager.on('player_companion_update', (data) => {
                addLog(`${data.playerName} ${data.type === 'obtain_pet' ? 'thu th·∫≠p linh th√∫' : 'k·∫øt duy√™n'}!`, 'info');
            });

            socketManager.on('player_quest_update', (data) => {
                addLog(`${data.playerName} ${data.type === 'accept_quest' ? 'nh·∫≠n nhi·ªám v·ª•' : 'ho√†n th√†nh nhi·ªám v·ª•'}!`, 'info');
            });

            socketManager.on('chat_message', (data) => {
                addChatMessage(data.playerName, data.message, data.timestamp);
            });
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            gameState.currentTab = tabName;
        }

        // UI Update functions
        function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            if (gameState.connected) {
                status.querySelector('span').textContent = 'Connected';
                status.className = 'connection-status connected';
            } else {
                status.querySelector('span').textContent = 'Disconnected';
                status.className = 'connection-status disconnected';
            }
        }

        function updatePlayerInfo() {
            // Update sidebar stats
            document.getElementById('healthText').textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            document.getElementById('manaText').textContent = `${gameState.player.mana}/${gameState.player.maxMana}`;
            document.getElementById('expText').textContent = `${gameState.player.experience}/${gameState.player.experienceToNext}`;
            
            // Update progress bars
            const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            const manaPercent = (gameState.player.mana / gameState.player.maxMana) * 100;
            const expPercent = (gameState.player.experience / gameState.player.experienceToNext) * 100;
            
            document.getElementById('healthBar').style.width = healthPercent + '%';
            document.getElementById('manaBar').style.width = manaPercent + '%';
            document.getElementById('expBar').style.width = expPercent + '%';
            
            // Update resources
            document.getElementById('goldAmount').textContent = gameState.player.resources.gold;
            document.getElementById('knbAmount').textContent = gameState.player.resources.kim_nguyen_bao;
            document.getElementById('spiritStones').textContent = gameState.player.resources.spirit_stones;
            document.getElementById('powerAmount').textContent = calculatePlayerPower();
            
            // Update cultivation
            document.getElementById('cultivationRealm').textContent = gameState.player.cultivation.realm;
            document.getElementById('cultivationStage').textContent = gameState.player.cultivation.stage;
            const cultivationPercent = (gameState.player.cultivation.progress / gameState.player.cultivation.progressToNext) * 100;
            document.getElementById('cultivationProgress').textContent = Math.floor(cultivationPercent) + '%';
            
            // Update companions
            document.getElementById('petName').textContent = gameState.player.pet.name || 'Ch∆∞a c√≥';
            document.getElementById('wifeName').textContent = gameState.player.wife.name || 'Ch∆∞a c√≥';
            
            // Update arena stats
            document.getElementById('arenaRank').textContent = gameState.player.arenaStats.rank;
            document.getElementById('arenaPoints').textContent = gameState.player.arenaStats.points;
            document.getElementById('arenaWins').textContent = gameState.player.arenaStats.wins;
            document.getElementById('arenaLosses').textContent = gameState.player.arenaStats.losses;
            
            // Update inventory
            updateInventoryDisplay();
            
            // Update quests
            updateQuestDisplay();
            
            // Update guild
            updateGuildDisplay();
        }

        function calculatePlayerPower() {
            let power = 0;
            Object.values(gameState.player.stats).forEach(stat => power += stat);
            
            if (gameState.player.pet && gameState.player.pet.petId) {
                const petPower = Object.values(gameState.player.pet.stats || {}).reduce((sum, stat) => sum + stat, 0);
                power += Math.floor(petPower * 0.3);
            }
            
            if (gameState.player.wife && gameState.player.wife.wifeId) {
                const wifePower = Object.values(gameState.player.wife.stats || {}).reduce((sum, stat) => sum + stat, 0);
                power += Math.floor(wifePower * 0.2);
            }
            
            return Math.floor(power);
        }

        function updatePlayersList() {
            // This function is now handled by the chat panel
            document.getElementById('onlineCount').textContent = gameState.players.length + 1;
        }

        function updateInventoryDisplay() {
            const container = document.getElementById('inventoryItems');
            if (!gameState.player.inventory || gameState.player.inventory.items.length === 0) {
                container.innerHTML = '<div class="inventory-slot">Tr·ªëng</div>';
                return;
            }

            container.innerHTML = gameState.player.inventory.items.map(item => `
                <div class="inventory-slot" onclick="useItem('${item.itemId}')">
                    <div>${getItemIcon(item.itemId)}</div>
                    <div>${item.quantity}x</div>
                </div>
            `).join('');
        }

        function updateQuestDisplay() {
            const container = document.getElementById('activeQuests');
            if (!gameState.player.activeQuests || gameState.player.activeQuests.length === 0) {
                container.innerHTML = '<p>Ch∆∞a c√≥ nhi·ªám v·ª•</p>';
                return;
            }

            container.innerHTML = gameState.player.activeQuests.map(quest => `
                <div class="quest-item">
                    <div class="quest-title">${quest.title || quest.questId}</div>
                    <div class="quest-progress">Ti·∫øn ƒë·ªô: ${quest.progress || 0}%</div>
                    <button class="btn btn-success" onclick="completeQuest('${quest.questId}')">Ho√†n th√†nh</button>
                </div>
            `).join('');
        }

        function updateGuildDisplay() {
            const container = document.getElementById('guildInfo');
            if (!gameState.player.guild) {
                container.innerHTML = '<p>Ch∆∞a tham gia bang h·ªôi</p><button class="btn" onclick="joinGuild(\'test_guild\')">Tham gia bang h·ªôi</button>';
                return;
            }

            container.innerHTML = `
                <p>Bang h·ªôi: ${gameState.player.guild.guildId}</p>
                <p>C·∫•p b·∫≠c: ${gameState.player.guild.rank}</p>
                <p>ƒê√≥ng g√≥p: ${gameState.player.guild.contribution}</p>
            `;
        }

        function getItemIcon(itemId) {
            const icons = {
                'hp_potion_small': 'üç∑',
                'mana_potion_small': 'üíô',
                'gold_pouch': 'üí∞',
                'cultivation_pill': 'üíä',
                'experience_pill': 'üíä'
            };
            return icons[itemId] || 'üì¶';
        }

        function addLog(message, type = 'info') {
            const log = document.getElementById('gameLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span>${message}</span>`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function addChatMessage(sender, message, timestamp) {
            const chat = document.getElementById('chatMessages');
            const time = new Date(timestamp).toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'chat-message';
            entry.innerHTML = `<span class="log-timestamp">[${time}]</span> <span class="chat-sender">${sender}:</span> ${message}`;
            chat.appendChild(entry);
            chat.scrollTop = chat.scrollHeight;
        }

        // Game action functions
        function useItem(itemId) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            socketManager.useItem(itemId);
        }

        function cultivate(duration) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            socketManager.cultivate(duration);
        }

        function obtainPet(petId) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            socketManager.obtainPet(petId);
        }

        function obtainWife(wifeId) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            socketManager.obtainWife(wifeId);
        }

        function acceptQuest(questId) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            socketManager.acceptQuest(questId);
        }

        function adminAddKNB(amount) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            socketManager.adminAddKNB(amount);
        }

        function buyItem(itemId, price) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            if (gameState.player.resources.gold < price) {
                addLog('Kh√¥ng ƒë·ªß v√†ng!', 'error');
                return;
            }
            // This would need to be implemented on server side
            addLog(`Mua ${itemId} v·ªõi gi√° ${price} v√†ng`, 'info');
        }

        function joinGuild(guildId) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            socketManager.joinGuild(guildId);
        }

        function completeQuest(questId) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            socketManager.completeQuest(questId);
        }

        function startArenaMatch() {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            addLog('B·∫Øt ƒë·∫ßu t√¨m ki·∫øm ƒë·ªëi th·ªß...', 'info');
            // This would need arena matchmaking logic
        }

        function purchasePremiumItem(itemId) {
            if (!gameState.connected) {
                addLog('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn server!', 'error');
                return;
            }
            socketManager.purchasePremiumItem(itemId);
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message && gameState.connected) {
                socketManager.sendChatMessage(message);
                input.value = '';
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // Game loop for UI updates
        let lastTime = 0;
        let frameCount = 0;
        let fps = 60;

        function gameLoop(currentTime) {
            // Calculate FPS
            frameCount++;
            if (currentTime - lastTime >= 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                document.getElementById('fps').textContent = fps;
                frameCount = 0;
                lastTime = currentTime;
            }

            // Update game time
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('gameTime').textContent = timeString;

            // Update ping (simulated)
            if (gameState.connected) {
                const ping = Math.floor(Math.random() * 50) + 10; // Simulated ping
                document.getElementById('ping').textContent = ping + 'ms';
            }

            requestAnimationFrame(gameLoop);
        }

        // Initialize game when page loads
        window.addEventListener('load', () => {
            initGame();
            requestAnimationFrame(gameLoop);
        });
    </script>
</body>
</html>
